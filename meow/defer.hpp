////////////////////////////////////////////////////////////////////////////////////////////////
// vim: set filetype=cpp autoindent noexpandtab tabstop=4 shiftwidth=4 foldmethod=marker :
// Copyright(c) Anton Povarov <anton.povarov@gmail.com>
////////////////////////////////////////////////////////////////////////////////////////////////

#ifndef MEOW__DEFER_HPP_
#define MEOW__DEFER_HPP_

#include <functional>

////////////////////////////////////////////////////////////////////////////////////////////////
namespace meow {
////////////////////////////////////////////////////////////////////////////////////////////////

	struct defer_wrapper_t
	{
		mutable std::function<void()> cleaner;

		~defer_wrapper_t()
		{
			if (cleaner)
				cleaner();
		}
	};


	#define MEOW_DEFER_EX(body) \
		auto const& BOOST_PP_CAT(defer_wrapper___,__LINE__) = meow::defer_wrapper_t { .cleaner = body }; \
	/**/

	#define MEOW_DEFER(body) \
		MEOW_DEFER_EX([&]() -> void { body })
	/**/

////////////////////////////////////////////////////////////////////////////////////////////////
} //namespace meow {
////////////////////////////////////////////////////////////////////////////////////////////////

#endif // MEOW__DEFER_HPP_
